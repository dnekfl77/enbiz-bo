<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.enbiz.bo.app.repository.system.StUserBaseMapper">

	<sql id="paginatedBase">
		LIMIT ${rowsPerPage} OFFSET (${pageIdx} - 1) * ${rowsPerPage}
	</sql>

	<select id="getUserCertification" resultType="com.enbiz.bo.app.dto.response.login.LoginResponse" parameterType="com.enbiz.bo.app.dto.request.login.LoginRequest">
		SELECT /* stUserBase.getUserCertification */
			   USER_ID
			 , USER_NM
			 , CELL_SCT_NO
			 , CELL_TXNO_NO
			 , CELL_END_NO
		  FROM ST_USER_BASE
		 WHERE USER_ID 			= #{loginId}
		   AND CELL_SCT_NO 		= #{cellSctNo}
		   AND CELL_TXNO_NO 	= #{cellTxnoNo}
		   AND CELL_END_NO 		= #{cellEndNo}
		   AND USE_YN = 'Y'
	</select>

	<select id="getChagePasswordConfirm" resultType="java.lang.Integer" parameterType="com.enbiz.bo.app.dto.request.login.LoginRequest">
		SELECT /* stUserBase.getChagePasswordConfirm */
			   COUNT(*)
		  FROM ST_USER_BASE
		 WHERE USER_ID 	= #{sysRegId}
		   AND PWD 		= #{originPwd}
	</select>

	<select id="getChagePasswordDayCheck" resultType="java.lang.Integer" parameterType="com.enbiz.bo.app.dto.request.login.LoginRequest">
		SELECT /* stUserBase.getChagePasswordDayCheck */
			   COUNT(*)
		  FROM ST_USER_BASE
		 WHERE USER_ID 	= #{loginId}
		   AND PWD 		= #{originPwd}
		   AND TO_CHAR(LST_PWD_CHG_DTM, 'YYYYMMDD') = TO_CHAR(NOW(),'YYYYMMDD')
		   AND INI_YN = 'N'
	</select>

	<select id="getStUserBaseExistsLogin" resultType="com.enbiz.bo.app.dto.response.login.LoginResponse" parameterType="com.enbiz.bo.app.dto.request.login.LoginRequest">
		SELECT /* stUserBase.getStUserBaseExistsLogin */
			   USER_ID
			 , USER_NM
			 , PWD
			 , USER_GB_CD
			 , FN_GET_CODENAME('UR001', USER_GB_CD) AS USER_GB_NM
			 , RT_GRP_NO
			 , JOB_GRP_CD
			 , FN_GET_CODENAME('UR002', JOB_GRP_CD) AS ORG_TYP_NM
			 , OCP_CD
			 , FN_GET_CODENAME('UR003', OCP_CD) AS OCP_NM
			 , WORK_STAT_CD
			 , FN_GET_CODENAME('UR004', WORK_STAT_CD) AS WORK_STAT_NM
			 , CELL_SCT_NO
			 , CELL_TXNO_NO
			 , CELL_END_NO
			 , EMAIL_ADDR
			 , IND_INFO_DEAL_YN
			 , USE_STRT_DT
			 , USE_END_DT
			 , RCNT_USE_DTM
			 , PWD_CNTN_FAIL_CNT
			 , LST_PWD_CHG_DTM
			 , PWD_LOCK_YN
			 , PWD_INI_YN
			 , USE_YN
			 , ENTR_NO
			 , CASE WHEN DATE_TRUNC('day', NOW() + INTERVAL '-6 MONTHS') > LST_PWD_CHG_DTM THEN 'Y'
					ELSE 'N'
			   END PASSWORD_CHANGE_YN
			 , ( SELECT LOGIN_IP_ADDR
				   FROM ST_LOGIN_LOG
				  WHERE USER_ID = SUB.USER_ID
				  ORDER BY LOGIN_LOG_SEQ DESC
				  LIMIT 1
			   ) AS LAST_LOGIN_IP_ADDR
			 , ( SELECT REF_2_VAL
				   FROM ST_STD_CD
				  WHERE GRP_CD='UR002'
					AND CD = SUB.JOB_GRP_CD
			   ) AS SYS_GB_CD
		  FROM ST_USER_BASE SUB
		 WHERE USER_ID = #{loginId}
		 <if test="pwd != null and pwd != ''">
		   AND PWD = #{pwd}
		 </if>  
		   AND USE_YN = 'Y'
	</select>




	<select id="getUserDetail" parameterType="String" resultType="StUserBase">
		SELECT /* stUserBase.getUserDetail */
			  USER_ID
			, USER_NM
			, PWD
			, USER_GB_CD
			, FN_GET_CODENAME('UR001', USER_GB_CD) AS USER_GB_NM
			, ENTR_NO
			, RT_GRP_NO
			, JOB_GRP_CD
			, DEPT_CD
			, FN_GET_CODENAME('UR002', JOB_GRP_CD) AS ORG_TYP_NM
			, OCP_CD
			, FN_GET_CODENAME('UR003', OCP_CD) AS OCP_NM
			, WORK_STAT_CD
			, FN_GET_CODENAME('UR004', WORK_STAT_CD) AS WORK_STAT_NM
			, TEL_RGN_NO
			, TEL_TXNO_NO
			, TEL_END_NO
			, CELL_SCT_NO
			, CELL_TXNO_NO
			, CELL_END_NO
			, CNSL_ENTP_NM
			, CTI_NO
			, ITEL_NO
			, EMAIL_ADDR
			, IND_INFO_DEAL_YN
			, USE_STRT_DT
			, USE_END_DT
			, RCNT_USE_DTM
			, PWD_CNTN_FAIL_CNT
			, LST_PWD_CHG_DTM
			, PWD_LOCK_YN
			, USE_YN
			, SYS_REG_ID
			, SYS_REG_DTM
			, SYS_MOD_ID
			, SYS_MOD_DTM
		FROM ST_USER_BASE
		WHERE USER_ID = #{userId}
	</select>


	<select id="getPasswd" resultType="String" parameterType="String">
		SELECT /* stUserBase.getPasswdConfirm */
			PWD
		FROM ST_USER_BASE
		WHERE USER_ID 	= #{userId}
	</select>

	<sql id="deptUserList">
		SELECT /* stUserBase.getDeptUserList */
		       USER_ID
			 , USER_GB_CD
			 , DEPT_CD
			 , ENTR_NO
			 , USER_NM
		  FROM ST_USER_BASE
		 WHERE DEPT_CD = #{deptCd}
		   AND USE_YN = 'Y'
	</sql>

	<select id="getDeptUserList"  parameterType="CsDeptUserRequest" resultType="CsDeptUserResponse">
		<include refid="deptUserList" />
		<include refid="paginatedBase" />
	</select>

	<select id="getDeptUserListCount" parameterType="CsDeptUserRequest" resultType="java.lang.Integer">
		SELECT /* stUserBase.getDeptUserListCount */
		       COUNT(*)
		  FROM (
		  <include refid="deptUserList" />
		  ) v
	</select>


</mapper>